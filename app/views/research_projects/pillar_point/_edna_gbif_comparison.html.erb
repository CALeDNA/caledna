<%
  taxon_rank = params[:taxon_rank] || 'phylum'

  def has_edna?(taxon)
    res = @gbif_taxa_with_edna.to_a.any? { |t| t['gbif_id'] == taxon['gbif_id'] }
  end

  def taxon_string(taxon)
    [
      taxon['kingdom'], taxon['phylum'], taxon['classname'], taxon['order'],
      taxon['family'], taxon['genus'], taxon['species']
    ].compact.join(', ')
  end

  def ncbi_taxon_string(taxon)
    return if taxon['hierarchy_names'].nil?
    taxa = {}
    taxon['hierarchy_names'][1..-2].gsub(/["]/, '').split('},{')
      .map{ |n| n.gsub(/[{}]/, '') }.first
      .split(', ')
      .each do |n|
        parts = n.split(': ')
        taxa[parts.first] = parts.last
      end

    [
      taxa['kingdom'], taxa['phylum'], taxa['class'], taxa['order'],
      taxa['family'], taxa['genus'], taxa['species']
    ].compact.join(', ')
  end

  def with_ncbi_count
    @gbif_taxa.select do |taxon|
      taxon['ncbi_id'].present?
    end.count
  end

  def with_edna_count
    @gbif_taxa_with_edna.count
  end

  def base_url
    '/research_projects/pillar-point?section=edna_gbif_comparison'
  end
%>



<ul class="nav nav-pills">
  <% ['phylum', 'class', 'order', 'family', 'genus', 'species'].each do |rank| %>
    <li class=<%= 'active' if rank == taxon_rank %>><a href="<%= base_url %>&taxon_rank=<%= rank %>">
      <%= rank %>
    </a></li>
  <% end %>
</ul><br>

<p>GBIF unique <%= taxon_rank %>: <%= @gbif_taxa.count %></p>
<p>GBIF unique <%= taxon_rank %> with NCBI ID: <%= with_ncbi_count %></p>
<p>GBIF unique <%= taxon_rank %> with eDNA match: <%= with_edna_count %></p>

<table class="table">
  <tr>
    <th><a href="<%= base_url %>&taxon_rank=<%= taxon_rank %>&sort=taxon">Taxon</a></th>
    <th><a href="<%= base_url %>&taxon_rank=<%= taxon_rank %>&sort=count">GBIF Occurences</a></th>
    <th>NCBI Match</th>
    <th>eDNA Match</th>
  </tr>
<% @gbif_taxa.each do |taxon| %>
  <tr>
    <td>
      <b>GBIF</b>
      <p><%= taxon_string(taxon) %></p>
      <p>GBIF ID: <%= link_to taxon['gbif_id'], "http://gbif.org/species/#{taxon['gbif_id']}" %></p>

      <%  if taxon['hierarchy_names'] %>
        <b>NCBI</b>
        <p><%= ncbi_taxon_string(taxon) %></p>
        <p><%= "rank: #{taxon['ncbi_rank']}" %></p>
        <p>
          NCBI ID: <%= link_to taxon['ncbi_id'], "https://www.ncbi.nlm.nih.gov/Taxonomy/Browser/wwwtax.cgi?mode=Info&id=#{taxon['ncbi_id']}&lvl=3" %>,
          <%= link_to 'CALeDNA page', taxon_path(id: taxon['ncbi_id'])%>
        </p>
      <% end %>
    </td>
    <td><%= taxon['count'] %></td>
    <td>
      <%= sanitize PillarPointHelper.check_or_x(taxon['ncbi_id']) %>
    </td>
    <td>
      <%= sanitize PillarPointHelper.check_or_x( has_edna?(taxon)) %>
    </td>
  </tr>
<% end %>
</table>
