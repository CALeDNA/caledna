 total_exec_time | prop_exec_time | ncalls |  sync_io_time   |                                                                                                                                                                           query
-----------------+----------------+--------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
x 00:28:06.991907 | 13.4%          | 765    | 00:00:00.445073 | SELECT gbif_ct.superkingdom, gbif_ct.kingdom, gbif_ct.phylum, gbif_ct.class_name,                                                                                                                                                                                                                                                                         +
                 |                |        |                 |           COUNT(distinct (gbifid)),                                                                                                                                                                                                                                                                                                                       +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 | ARRAY_AGG(DISTINCT(                                                                                                                                                                                                                                                                                                                                       +
                 |                |        |                 |   g_taxa.taxonkey || $1 || coalesce(gbif_ct.source_superkingdom, $2) || $3 ||coalesce(gbif_ct.source_kingdom, $4) || $5 ||coalesce(gbif_ct.source_phylum, $6)|| $7 ||coalesce(gbif_ct.source_class_name, $8)                                                                                                                                              +
                 |                |        |                 | )) AS gbif_taxa,                                                                                                                                                                                                                                                                                                                                          +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 | (SELECT ARRAY_AGG(pillar_point.ncbi_nodes.taxon_id || $9 ||  coalesce(ncbi_nodes.hierarchy_names ->> $10, $11) || $12 ||coalesce(ncbi_nodes.hierarchy_names ->> $13, $14) || $15 ||coalesce(ncbi_nodes.hierarchy_names ->> $16, $17)|| $18 ||coalesce(ncbi_nodes.hierarchy_names ->> $19, $20))                                                           +
                 |                |        |                 | FROM pillar_point.ncbi_nodes                                                                                                                                                                                                                                                                                                                              +
                 |                |        |                 | JOIN pillar_point.ncbi_names                                                                                                                                                                                                                                                                                                                              +
                 |                |        |                 |   ON pillar_point.ncbi_nodes.taxon_id = pillar_point.ncbi_names.taxon_id                                                                                                                                                                                                                                                                                  +
                 |                |        |                 | WHERE lower(pillar_point.ncbi_names.name) =                                                                                                                                                                                                                                                                                                               +
                 |                |        |                 |   lower(gbif_ct.class_name)                                                                                                                                                                                                                                                                                                                               +
                 |                |        |                 | ) AS ncbi_taxa                                                                                                                                                                                                                                                                                                                                            +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |           FROM pillar_point.combine_taxa as gbif_ct                                                                                                                                                                                                                                                                                                       +
                 |                |        |                 | JOIN external.gbif_occurrences                                                                                                                                                                                                                                                                                                                            +
                 |                |        |                 |   ON external.gbif_occurrences.taxonkey =                                                                                                                                                                                                                                                                                                                 +
                 |                |        |                 |     gbif_ct.source_taxon_id                                                                                                                                                                                                                                                                                                                               +
                 |                |        |                 |   AND gbif_ct.source = $21                                                                                                                                                                                                                                                                                                                                +
                 |                |        |                 | JOIN  research_project_sources                                                                                                                                                                                                                                                                                                                            +
                 |                |        |                 |   ON external.gbif_occurrences.gbifid =                                                                                                                                                                                                                                                                                                                   +
                 |                |        |                 |     research_project_sources.sourceable_id                                                                                                                                                                                                                                                                                                                +
                 |                |        |                 |   AND research_project_id = $22                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |   AND sourceable_type = $23                                                                                                                                                                                                                                                                                                                               +
                 |                |        |                 |   AND metadata ->> $24 != $25                                                                                                                                                                                                                                                                                                                             +
                 |                |        |                 | LEFT JOIN pillar_point.combine_taxa AS edna_ct                                                                                                                                                                                                                                                                                                            +
                 |                |        |                 |   ON lower(edna_ct.class_name) =                                                                                                                                                                                                                                                                                                                          +
                 |                |        |                 |     lower(gbif_ct.class_name)                                                                                                                                                                                                                                                                                                                             +
                 |                |        |                 |   AND (edna_ct.source = $26 OR edna_ct.source = $27)                                                                                                                                                                                                                                                                                                      +
                 |                |        |                 | LEFT JOIN external.gbif_occ_taxa as g_taxa                                                                                                                                                                                                                                                                                                                +
                 |                |        |                 |   ON gbif_ct.source_class_name =                                                                                                                                                                                                                                                                                                                          +
                 |                |        |                 |     g_taxa.classname                                                                                                                                                                                                                                                                                                                                      +
                 |                |        |                 |   AND g_taxa.taxonrank = $28                                                                                                                                                                                                                                                                                                                              +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |           WHERE gbif_ct.source = $29                                                                                                                                                                                                                                                                                                                      +
                 |                |        |                 |           AND gbif_ct.class_name IS NOT NULL                                                                                                                                                                                                                                                                                                              +
                 |                |        |                 |           AND edna_ct.class_name IS NOT NULL                                                                                                                                                                                                                                                                                                              +
                 |                |        |                 |           GROUP BY gbif_ct.superkingdom, gbif_ct.kingdom, gbif_ct.phylum, gbif_ct.class_name, edna_ct.class_name                                                                                                                                                                                                                                          +
                 |                |        |                 |           ORDER BY gbif_ct.superkingdom, gbif_ct.kingdom, gbif_ct.phylum, gbif_ct.class_name, edna_ct.class_name

x 00:18:23.748369 | 8.8%           | 350    | 00:00:00.031323 | SELECT gbif_ct.superkingdom, gbif_ct.kingdom, gbif_ct.phylum,                                                                                                                                                                                                                                                                                             +
                 |                |        |                 |           COUNT(distinct (gbifid)),                                                                                                                                                                                                                                                                                                                       +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 | ARRAY_AGG(DISTINCT(                                                                                                                                                                                                                                                                                                                                       +
                 |                |        |                 |   g_taxa.taxonkey || $1 || coalesce(gbif_ct.source_superkingdom, $2) || $3 ||coalesce(gbif_ct.source_kingdom, $4) || $5 ||coalesce(gbif_ct.source_phylum, $6)                                                                                                                                                                                             +
                 |                |        |                 | )) AS gbif_taxa,                                                                                                                                                                                                                                                                                                                                          +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 | (SELECT ARRAY_AGG(pillar_point.ncbi_nodes.taxon_id || $7 ||  coalesce(ncbi_nodes.hierarchy_names ->> $8, $9) || $10 ||coalesce(ncbi_nodes.hierarchy_names ->> $11, $12) || $13 ||coalesce(ncbi_nodes.hierarchy_names ->> $14, $15))                                                                                                                       +
                 |                |        |                 | FROM pillar_point.ncbi_nodes                                                                                                                                                                                                                                                                                                                              +
                 |                |        |                 | JOIN pillar_point.ncbi_names                                                                                                                                                                                                                                                                                                                              +
                 |                |        |                 |   ON pillar_point.ncbi_nodes.taxon_id = pillar_point.ncbi_names.taxon_id                                                                                                                                                                                                                                                                                  +
                 |                |        |                 | WHERE lower(pillar_point.ncbi_names.name) =                                                                                                                                                                                                                                                                                                               +
                 |                |        |                 |   lower(gbif_ct.phylum)                                                                                                                                                                                                                                                                                                                                   +
                 |                |        |                 | ) AS ncbi_taxa                                                                                                                                                                                                                                                                                                                                            +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |           FROM pillar_point.combine_taxa as gbif_ct                                                                                                                                                                                                                                                                                                       +
                 |                |        |                 | JOIN external.gbif_occurrences                                                                                                                                                                                                                                                                                                                            +
                 |                |        |                 |   ON external.gbif_occurrences.taxonkey =                                                                                                                                                                                                                                                                                                                 +
                 |                |        |                 |     gbif_ct.source_taxon_id                                                                                                                                                                                                                                                                                                                               +
                 |                |        |                 |   AND gbif_ct.source = $16                                                                                                                                                                                                                                                                                                                                +
                 |                |        |                 | JOIN  research_project_sources                                                                                                                                                                                                                                                                                                                            +
                 |                |        |                 |   ON external.gbif_occurrences.gbifid =                                                                                                                                                                                                                                                                                                                   +
                 |                |        |                 |     research_project_sources.sourceable_id                                                                                                                                                                                                                                                                                                                +
                 |                |        |                 |   AND research_project_id = $17                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |   AND sourceable_type = $18                                                                                                                                                                                                                                                                                                                               +
                 |                |        |                 |   AND metadata ->> $19 != $20                                                                                                                                                                                                                                                                                                                             +
                 |                |        |                 | LEFT JOIN pillar_point.combine_taxa AS edna_ct                                                                                                                                                                                                                                                                                                            +
                 |                |        |                 |   ON lower(edna_ct.phylum) =                                                                                                                                                                                                                                                                                                                              +
                 |                |        |                 |     lower(gbif_ct.phylum)                                                                                                                                                                                                                                                                                                                                 +
                 |                |        |                 |   AND (edna_ct.source = $21 OR edna_ct.source = $22)                                                                                                                                                                                                                                                                                                      +
                 |                |        |                 | LEFT JOIN external.gbif_occ_taxa as g_taxa                                                                                                                                                                                                                                                                                                                +
                 |                |        |                 |   ON gbif_ct.source_phylum =                                                                                                                                                                                                                                                                                                                              +
                 |                |        |                 |     g_taxa.phylum                                                                                                                                                                                                                                                                                                                                         +
                 |                |        |                 |   AND g_taxa.taxonrank = $23                                                                                                                                                                                                                                                                                                                              +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |           WHERE gbif_ct.source = $24                                                                                                                                                                                                                                                                                                                      +
                 |                |        |                 |           AND gbif_ct.phylum IS NOT NULL                                                                                                                                                                                                                                                                                                                  +
                 |                |        |                 |           AND edna_ct.phylum IS NOT NULL                                                                                                                                                                                                                                                                                                                  +
                 |                |        |                 |           GROUP BY gbif_ct.superkingdom, gbif_ct.kingdom, gbif_ct.phylum, edna_ct.phylum                                                                                                                                                                                                                                                                  +
                 |                |        |                 |           ORDER BY gbif_ct.superkingdom, gbif_ct.kingdom, gbif_ct.phylum, edna_ct.phylum

x 00:17:31.877544 | 8.4%           | 68,382 | 00:00:02.000193 | SELECT  "result_taxa".* FROM "result_taxa" WHERE (clean_taxonomy_string = $3 OR clean_taxonomy_string_phylum = $4) AND "result_taxa"."taxon_rank" = $1 ORDER BY "result_taxa"."id" ASC LIMIT $2
x 00:11:13.70444  | 5.4%           | 48,300 | 00:00:02.452587 | SELECT  "result_taxa".* FROM "result_taxa" WHERE (clean_taxonomy_string = $2 OR clean_taxonomy_string_phylum = $3) ORDER BY "result_taxa"."id" ASC LIMIT $1

x 00:14:57.101928 | 7.2%           | 2,865  | 00:00:00.467238 | select $1 as taxon_name,                                                                                                                                                                                                                                                                                                                                  +
                 |                |        |                 |         $2 as taxon_path,                                                                                                                                                                                                                                                                                                                                 +
                 |                |        |                 |         $3 as taxon_rank,                                                                                                                                                                                                                                                                                                                                 +
                 |                |        |                 |         $4 IN(                                                                                                                                                                                                                                                                                                                                            +
                 |                |        |                 |           SELECT unnest(array[kingdom, phylum, classname, "order", family,                                                                                                                                                                                                                                                                                +
                 |                |        |                 |           genus, species])                                                                                                                                                                                                                                                                                                                                +
                 |                |        |                 |           FROM research_project_sources                                                                                                                                                                                                                                                                                                                   +
                 |                |        |                 |           JOIN external.gbif_occurrences                                                                                                                                                                                                                                                                                                                  +
                 |                |        |                 |           ON external.gbif_occurrences.gbifid =                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |             research_project_sources.sourceable_id                                                                                                                                                                                                                                                                                                        +
                 |                |        |                 |           WHERE research_project_id = $5                                                                                                                                                                                                                                                                                                                  +
                 |                |        |                 |           AND sourceable_type = $6                                                                                                                                                                                                                                                                                                                        +
                 |                |        |                 |           AND metadata ->> $7 != $8                                                                                                                                                                                                                                                                                                                       +
                 |                |        |                 |         ) as gbif_match,                                                                                                                                                                                                                                                                                                                                  +
                 |                |        |                 |         $9 IN(                                                                                                                                                                                                                                                                                                                                            +
                 |                |        |                 |           SELECT  unnest(string_to_array(full_taxonomy_string, $10))                                                                                                                                                                                                                                                                                      +
                 |                |        |                 |           FROM  pillar_point.asvs as pp_asvs                                                                                                                                                                                                                                                                                                              +
                 |                |        |                 |           JOIN pillar_point.ncbi_nodes                                                                                                                                                                                                                                                                                                                    +
                 |                |        |                 |             ON pillar_point.ncbi_nodes.taxon_id = pp_asvs.taxon_id                                                                                                                                                                                                                                                                                        +
                 |                |        |                 |           WHERE pp_asvs.research_project_id = $11                                                                                                                                                                                                                                                                                                         +
                 |                |        |                 |         ) as edna_match


 00:14:10.535787 | 6.8%           | 2,865  | 00:00:28.511199 | SELECT DISTINCT                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |         "sourceTaxonName" AS source_taxon_name,                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |         "sourceTaxonIds" AS source_taxon_ids,                                                                                                                                                                                                                                                                                                             +
                 |                |        |                 |         "sourceTaxonPathNames" AS source_taxon_path,                                                                                                                                                                                                                                                                                                      +
                 |                |        |                 |         "sourceTaxonRank" AS source_taxon_rank,                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |         "interactionTypeName" AS interaction_type,                                                                                                                                                                                                                                                                                                        +
                 |                |        |                 |         "targetTaxonName" AS target_taxon_name,                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |         "targetTaxonIds" AS target_taxon_ids,                                                                                                                                                                                                                                                                                                             +
                 |                |        |                 |         "targetTaxonPathNames" AS target_taxon_path,                                                                                                                                                                                                                                                                                                      +
                 |                |        |                 |         "targetTaxonRank" AS target_taxon_rank,                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |         $1 as is_source,                                                                                                                                                                                                                                                                                                                                  +
                 |                |        |                 |         ("sourceTaxonName" IN                                                                                                                                                                                                                                                                                                                             +
                 |                |        |                 |           (SELECT unnest(string_to_array(full_taxonomy_string, $2))                                                                                                                                                                                                                                                                                       +
                 |                |        |                 |           FROM pillar_point.asvs as pp_asvs                                                                                                                                                                                                                                                                                                               +
                 |                |        |                 |           JOIN pillar_point.ncbi_nodes                                                                                                                                                                                                                                                                                                                    +
                 |                |        |                 |           ON pillar_point.ncbi_nodes.taxon_id = pp_asvs.taxon_id                                                                                                                                                                                                                                                                                          +
                 |                |        |                 |           WHERE pp_asvs.research_project_id = $3                                                                                                                                                                                                                                                                                                          +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |           INTERSECT                                                                                                                                                                                                                                                                                                                                       +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |           SELECT ("sourceTaxonName")                                                                                                                                                                                                                                                                                                                      +
                 |                |        |                 |           FROM external.globi_interactions                                                                                                                                                                                                                                                                                                                +
                 |                |        |                 |           WHERE "targetTaxonName" = $4 )                                                                                                                                                                                                                                                                                                                  +
                 |                |        |                 |         ) AS edna_match,                                                                                                                                                                                                                                                                                                                                  +
                 |                |        |                 |         ("sourceTaxonName" in                                                                                                                                                                                                                                                                                                                             +
                 |                |        |                 |           (SELECT unnest(ARRAY[kingdom, phylum, classname, "order", family,                                                                                                                                                                                                                                                                               +
                 |                |        |                 |           genus, species])                                                                                                                                                                                                                                                                                                                                +
                 |                |        |                 |           FROM research_project_sources                                                                                                                                                                                                                                                                                                                   +
                 |                |        |                 |           JOIN external.gbif_occurrences                                                                                                                                                                                                                                                                                                                  +
                 |                |        |                 |           ON external.gbif_occurrences.gbifid =                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |             research_project_sources.sourceable_id                                                                                                                                                                                                                                                                                                        +
                 |                |        |                 |           WHERE research_project_sources.research_project_id = $5                                                                                                                                                                                                                                                                                         +
                 |                |        |                 |           AND sourceable_type = $6                                                                                                                                                                                                                                                                                                                        +
                 |                |        |                 |           AND metadata ->> $7 != $8                                                                                                                                                                                                                                                                                                                       +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |           INTERSECT                                                                                                                                                                                                                                                                                                                                       +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |           SELECT "sourceTaxonName"                                                                                                                                                                                                                                                                                                                        +
                 |                |        |                 |           FROM external.globi_interactions                                                                                                                                                                                                                                                                                                                +
                 |                |        |                 |           WHERE "targetTaxonName" = $9 )                                                                                                                                                                                                                                                                                                                  +
                 |                |        |                 |         ) as gbif_match                                                                                                                                                                                                                                                                                                                                   +
                 |                |        |                 |         FROM external.globi_interactions                                                                                                                                                                                                                                                                                                                  +
                 |                |        |                 |         LEFT JOIN external.globi_requests                                                                                                                                                                                                                                                                                                                 +
                 |                |        |                 |         ON external.globi_requests.taxon_name =                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |           external.globi_interactions."targetTaxonName"                                                                                                                                                                                                                                                                                                   +
                 |                |        |                 |         WHERE "sourceTaxonName" != $10                                                                                                                                                                                                                                                                                                                    +
                 |                |        |                 |         AND "sourceTaxonName" != $11                                                                                                                                                                                                                                                                                                                      +
                 |                |        |                 |         AND "sourceTaxonId" != $12                                                                                                                                                                                                                                                                                                                        +
                 |                |        |                 |         AND "targetTaxonName" = $13                                                                                                                                                                                                                                                                                                                       +
                 |                |        |                 |         and globi_requests.taxon_id[$14]::text =                                                                                                                                                                                                                                                                                                          +
                 |                |        |                 |         ANY(string_to_array("targetTaxonIds", $15))                                                                                                                                                                                                                                                                                                       +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |         UNION                                                                                                                                                                                                                                                                                                                                             +
                 |                |        |                 |                   SELECT DISTINCT                                                                                                                                                                                                                                                                                                                         +
                 |                |        |                 |           "sourceTaxonName" AS source_taxon_name,                                                                                                                                                                                                                                                                                                         +
                 |                |        |                 |           "sourceTaxonIds" AS source_taxon_ids,                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |           "sourceTaxonPathNames" AS source_taxon_path,                                                                                                                                                                                                                                                                                                    +
                 |                |        |                 |           "sourceTaxonRank" AS source_taxon_rank,                                                                                                                                                                                                                                                                                                         +
                 |                |        |                 |           "interactionTypeName" AS interaction_type,                                                                                                                                                                                                                                                                                                      +
                 |                |        |                 |           "targetTaxonName" AS target_taxon_name,                                                                                                                                                                                                                                                                                                         +
                 |                |        |                 |           "targetTaxonIds" AS target_taxon_ids,                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |           "targetTaxonPathNames" AS target_taxon_path,                                                                                                                                                                                                                                                                                                    +
                 |                |        |                 |           "targetTaxonRank" AS target_taxon_rank,                                                                                                                                                                                                                                                                                                         +
                 |                |        |                 |           $16 as is_source,                                                                                                                                                                                                                                                                                                                               +
                 |                |        |                 |           ("targetTaxonName" IN                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |           (SELECT unnest(string_to_array(full_taxonomy_string, $17))                                                                                                                                                                                                                                                                                      +
                 |                |        |                 |           FROM  pillar_point.asvs as pp_asvs                                                                                                                                                                                                                                                                                                              +
                 |                |        |                 |           JOIN pillar_point.ncbi_nodes                                                                                                                                                                                                                                                                                                                    +
                 |                |        |                 |             ON pillar_point.ncbi_nodes.taxon_id = pp_asvs.taxon_id                                                                                                                                                                                                                                                                                        +
                 |                |        |                 |           WHERE pp_asvs.research_project_id = $18                                                                                                                                                                                                                                                                                                         +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |           INTERSECT                                                                                                                                                                                                                                                                                                                                       +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |           SELECT ("targetTaxonName")                                                                                                                                                                                                                                                                                                                      +
                 |                |        |                 |           FROM external.globi_interactions                                                                                                                                                                                                                                                                                                                +
                 |                |        |                 |           WHERE "sourceTaxonName" = $19 )                                                                                                                                                                                                                                                                                                                 +
                 |                |        |                 |         ) AS edna_match,                                                                                                                                                                                                                                                                                                                                  +
                 |                |        |                 |         ("targetTaxonName" in                                                                                                                                                                                                                                                                                                                             +
                 |                |        |                 |           (SELECT unnest(ARRAY[kingdom, phylum, classname, "order", family,                                                                                                                                                                                                                                                                               +
                 |                |        |                 |           genus, species])                                                                                                                                                                                                                                                                                                                                +
                 |                |        |                 |           FROM research_project_sources                                                                                                                                                                                                                                                                                                                   +
                 |                |        |                 |           JOIN external.gbif_occurrences                                                                                                                                                                                                                                                                                                                  +
                 |                |        |                 |           ON external.gbif_occurrences.gbifid =                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |             research_project_sources.sourceable_id                                                                                                                                                                                                                                                                                                        +
                 |                |        |                 |           WHERE research_project_sources.research_project_id = $20                                                                                                                                                                                                                                                                                        +
                 |                |        |                 |           AND sourceable_type = $21                                                                                                                                                                                                                                                                                                                       +
                 |                |        |                 |           AND metadata ->> $22 != $23                                                                                                                                                                                                                                                                                                                     +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |           INTERSECT                                                                                                                                                                                                                                                                                                                                       +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |           SELECT "targetTaxonName"                                                                                                                                                                                                                                                                                                                        +
                 |                |        |                 |           FROM external.globi_interactions                                                                                                                                                                                                                                                                                                                +
                 |                |        |                 |           WHERE "sourceTaxonName" = $24 )                                                                                                                                                                                                                                                                                                                 +
                 |                |        |                 |         ) as gbif_match                                                                                                                                                                                                                                                                                                                                   +
                 |                |        |                 |           FROM external.globi_interactions                                                                                                                                                                                                                                                                                                                +
                 |                |        |                 |           LEFT JOIN external.globi_requests                                                                                                                                                                                                                                                                                                               +
                 |                |        |                 |           ON external.globi_requests.taxon_name =                                                                                                                                                                                                                                                                                                         +
                 |                |        |                 |             external.globi_interactions."sourceTaxonName"                                                                                                                                                                                                                                                                                                 +
                 |                |        |                 |           WHERE "targetTaxonName" != $25                                                                                                                                                                                                                                                                                                                  +
                 |                |        |                 |           AND "targetTaxonName" != $26                                                                                                                                                                                                                                                                                                                    +
                 |                |        |                 |           AND "targetTaxonId" != $27                                                                                                                                                                                                                                                                                                                      +
                 |                |        |                 |           AND "sourceTaxonName" = $28                                                                                                                                                                                                                                                                                                                     +
                 |                |        |                 |           AND globi_requests.taxon_id[$29]::text =                                                                                                                                                                                                                                                                                                        +
                 |                |        |                 |             ANY(string_to_array("sourceTaxonIds", $30))                                                                                                                                                                                                                                                                                                   +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |         ORDER BY edna_match DESC, gbif_match DESC, interaction_type

 00:14:03.190871 | 6.7%           | 3,419  | 00:00:01.478534 | SELECT COUNT(DISTINCT(taxon_id)) FROM "asvs" JOIN research_projects                                                                                                                                                                                                                                                                                       +
                 |                |        |                 |   ON asvs.research_project_id = research_projects.id                                                                                                                                                                                                                                                                                                      +
                 |                |        |                 |   AND research_projects.published = $1

 00:11:05.067501 | 5.3%           | 469    | 00:00:00.267605 | SELECT "samples"."id", "samples"."latitude", "samples"."longitude", "samples"."barcode", "samples"."status_cd", "samples"."substrate_cd", "samples"."location", "samples"."collection_date", ARRAY_AGG(DISTINCT(primers.name)) FILTER (WHERE primers.name IS NOT NULL)                                                                                    +
                 |                |        |                 | AS primer_names, ARRAY_AGG(DISTINCT(primers.id)) FILTER (WHERE primers.id IS NOT NULL)                                                                                                                                                                                                                                                                    +
                 |                |        |                 | AS primer_ids, COUNT(DISTINCT asvs.taxon_id) as taxa_count FROM "samples" LEFT JOIN asvs ON asvs.sample_id = samples.id                                                                                                                                                                                                                                   +
                 |                |        |                 | LEFT JOIN primers ON primers.id = asvs.primer_id LEFT JOIN research_projects                                                                                                                                                                                                                                                                              +
                 |                |        |                 |   ON asvs.research_project_id = research_projects.id                                                                                                                                                                                                                                                                                                      +
                 |                |        |                 |   AND research_projects.published = $1 WHERE (CASE                                                                                                                                                                                                                                                                                                        +
                 |                |        |                 |   WHEN research_projects.published IS NULL THEN status_cd = $2                                                                                                                                                                                                                                                                                            +
                 |                |        |                 |   ELSE status_cd = $3                                                                                                                                                                                                                                                                                                                                     +
                 |                |        |                 |   END) GROUP BY "samples"."id" ORDER BY "samples"."created_at" ASC


 00:06:09.527943 | 2.9%           | 1,466  | 00:00:00.622172 | SELECT gbif_ct.superkingdom, gbif_ct.kingdom, gbif_ct.phylum, gbif_ct.class_name, gbif_ct.order,                                                                                                                                                                                                                                                          +
                 |                |        |                 |           COUNT(distinct (gbifid)),                                                                                                                                                                                                                                                                                                                       +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 | ARRAY_AGG(DISTINCT(                                                                                                                                                                                                                                                                                                                                       +
                 |                |        |                 |   g_taxa.taxonkey || $1 || coalesce(gbif_ct.source_superkingdom, $2) || $3 ||coalesce(gbif_ct.source_kingdom, $4) || $5 ||coalesce(gbif_ct.source_phylum, $6)|| $7 ||coalesce(gbif_ct.source_class_name, $8)|| $9 ||coalesce(gbif_ct.source_order, $10)                                                                                                   +
                 |                |        |                 | )) AS gbif_taxa,                                                                                                                                                                                                                                                                                                                                          +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 | (SELECT ARRAY_AGG(pillar_point.ncbi_nodes.taxon_id || $11 ||  coalesce(ncbi_nodes.hierarchy_names ->> $12, $13) || $14 ||coalesce(ncbi_nodes.hierarchy_names ->> $15, $16) || $17 ||coalesce(ncbi_nodes.hierarchy_names ->> $18, $19)|| $20 ||coalesce(ncbi_nodes.hierarchy_names ->> $21, $22)|| $23 ||coalesce(ncbi_nodes.hierarchy_names ->> $24, $25))+
                 |                |        |                 | FROM pillar_point.ncbi_nodes                                                                                                                                                                                                                                                                                                                              +
                 |                |        |                 | JOIN pillar_point.ncbi_names                                                                                                                                                                                                                                                                                                                              +
                 |                |        |                 |   ON pillar_point.ncbi_nodes.taxon_id = pillar_point.ncbi_names.taxon_id                                                                                                                                                                                                                                                                                  +
                 |                |        |                 | WHERE lower(pillar_point.ncbi_names.name) =                                                                                                                                                                                                                                                                                                               +
                 |                |        |                 |   lower(gbif_ct.order)                                                                                                                                                                                                                                                                                                                                    +
                 |                |        |                 | ) AS ncbi_taxa                                                                                                                                                                                                                                                                                                                                            +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |           FROM pillar_point.combine_taxa as gbif_ct                                                                                                                                                                                                                                                                                                       +
                 |                |        |                 | JOIN external.gbif_occurrences                                                                                                                                                                                                                                                                                                                            +
                 |                |        |                 |   ON external.gbif_occurrences.taxonkey =                                                                                                                                                                                                                                                                                                                 +
                 |                |        |                 |     gbif_ct.source_taxon_id                                                                                                                                                                                                                                                                                                                               +
                 |                |        |                 |   AND gbif_ct.source = $26                                                                                                                                                                                                                                                                                                                                +
                 |                |        |                 | JOIN  research_project_sources                                                                                                                                                                                                                                                                                                                            +
                 |                |        |                 |   ON external.gbif_occurrences.gbifid =                                                                                                                                                                                                                                                                                                                   +
                 |                |        |                 |     research_project_sources.sourceable_id                                                                                                                                                                                                                                                                                                                +
                 |                |        |                 |   AND research_project_id = $27                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |   AND sourceable_type = $28                                                                                                                                                                                                                                                                                                                               +
                 |                |        |                 |   AND metadata ->> $29 != $30                                                                                                                                                                                                                                                                                                                             +
                 |                |        |                 | LEFT JOIN pillar_point.combine_taxa AS edna_ct                                                                                                                                                                                                                                                                                                            +
                 |                |        |                 |   ON lower(edna_ct.order) =                                                                                                                                                                                                                                                                                                                               +
                 |                |        |                 |     lower(gbif_ct.order)                                                                                                                                                                                                                                                                                                                                  +
                 |                |        |                 |   AND (edna_ct.source = $31 OR edna_ct.source = $32)                                                                                                                                                                                                                                                                                                      +
                 |                |        |                 | LEFT JOIN external.gbif_occ_taxa as g_taxa                                                                                                                                                                                                                                                                                                                +
                 |                |        |                 |   ON gbif_ct.source_order =                                                                                                                                                                                                                                                                                                                               +
                 |                |        |                 |     g_taxa.order                                                                                                                                                                                                                                                                                                                                          +
                 |                |        |                 |   AND g_taxa.taxonrank = $33                                                                                                                                                                                                                                                                                                                              +
                 |                |        |                 |                                                                                                                                                                                                                                                                                                                                                           +
                 |                |        |                 |           WHERE gbif_ct.source = $34                                                                                                                                                                                                                                                                                                                      +
                 |                |        |                 |           AND gbif_ct.order IS NOT NULL                                                                                                                                                                                                                                                                                                                   +
                 |                |        |                 |           AND edna_ct.order IS NOT NULL                                                                                                                                                                                                                                                                                                                   +
                 |                |        |                 |           GROUP BY gbif_ct.superkingdom, gbif_ct.kingdom, gbif_ct.phylum, gbif_ct.class_name, gbif_ct.order, edna_ct.order                                                                                                                                                                                                                                +
                 |                |        |                 |           ORDER BY gbif_ct.superkingdom, gbif_ct.kingdom, gbif_ct.phylum, gbif_ct.class_name, gbif_ct.order, edna_ct.order
(10 rows)

